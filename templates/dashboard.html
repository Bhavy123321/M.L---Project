{% extends "base.html" %}
{% set title = brand_name ~ " • Dashboard" %}

{% block content %}
<section class="heroWrap">
  <div class="container">
    <div class="glassCard">

      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <div class="pill">Dashboard</div>
          <h2 class="heroTitle mt-2">Loan Predictions Overview</h2>
          <p class="heroText mb-0">Approved/Rejected counts + charts + recent predictions.</p>
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <!-- ✅ FIXED: Predictor route -->
          <a class="btn btn-outline-light" href="/predict">Go to Predictor</a>
          <a class="btn btn-outline-light" href="/reviews">Reviews</a>
        </div>
      </div>

      <div class="divider"></div>

      <!-- COUNTS -->
      <div class="row g-3">
        <div class="col-md-4">
          <div class="statTile">
            <div class="statLabel">Total Predictions</div>
            <div class="statValue">{{ total }}</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="statTile">
            <div class="statLabel">Approved</div>
            <div class="statValue" style="color: rgba(46, 213, 115, .95);">{{ approved }}</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="statTile">
            <div class="statLabel">Rejected</div>
            <div class="statValue" style="color: rgba(255, 71, 87, .95);">{{ rejected }}</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- CHARTS -->
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="featureCard2">
            <div class="f2Top">Approval Split</div>
            <div class="f2Big">Approved vs Rejected</div>
            <div style="height: 280px;">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="featureCard2">
            <div class="f2Top">Trend</div>
            <div class="f2Big">Predictions over time</div>
            <div style="height: 280px;">
              <canvas id="lineChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- RECENT -->
      <div class="featureCard2">
        <div class="f2Top">Recent Predictions</div>
        <div class="f2Big">Last {{ recent|length }} entries</div>

        <div class="table-responsive mt-3">
          <table class="table table-dark table-hover align-middle mb-0" style="border-radius:14px; overflow:hidden;">
            <thead>
              <tr>
                <th>Date</th>
                <th>Age</th>
                <th>Income</th>
                <th>Loan</th>
                <th>Credit</th>
                <th>DTI</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for r in recent %}
              <tr>
                <td>{{ r.created_at }}</td>
                <td>{{ r.Age }}</td>
                <td>{{ r.Income }}</td>
                <td>{{ r.LoanAmount }}</td>
                <td>{{ r.CreditScore }}</td>
                <td>{{ r.DTIRatio }}</td>
                <td>
                  {% if r.result == "Approved" %}
                    <span class="badge bg-success">Approved</span>
                  {% else %}
                    <span class="badge bg-danger">Rejected</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const approved = {{ approved }};
  const rejected = {{ rejected }};
  const trendLabels = {{ trend_labels|tojson }};
  const trendCounts = {{ trend_counts|tojson }};

  // PIE
  new Chart(document.getElementById("pieChart"), {
    type: "doughnut",
    data: {
      labels: ["Approved", "Rejected"],
      datasets: [{ data: [approved, rejected], borderWidth: 0 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: "#fff" } } }
    }
  });

  // LINE
  new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: {
      labels: trendLabels,
      datasets: [{
        label: "Predictions",
        data: trendCounts,
        tension: 0.35,
        borderWidth: 3,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { color: "#fff" }, grid: { color: "rgba(255,255,255,.08)" } },
        y: { ticks: { color: "#fff" }, grid: { color: "rgba(255,255,255,.08)" }, beginAtZero: true }
      },
      plugins: { legend: { labels: { color: "#fff" } } }
    }
  });
</script>
{% endblock %}
